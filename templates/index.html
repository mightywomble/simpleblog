<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Git-Powered Blog</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.9.1/showdown.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Enhanced Glass-like Effect  5 G Modern Design */
        .glass {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(15px) saturate(150%);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0px 15px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Enhanced Article Modal & Content Styling */
        #article-modal {
            background: rgba(0, 0, 0, 0.7);
        }

        #modal-content {
            background: rgba(255, 255, 255, 0.9);
            padding: 2rem;
            border-radius: 15px;
            color: #374151;
            line-height: 1.7;
        }

        /* Headings */
        #modal-content h1, #modal-content h2, #modal-content h3, #modal-content h4 {
            font-weight: 700;
            color: #111827;
            margin-top: 1.5em;
            margin-bottom: 0.75em;
            line-height: 1.2;
        }
        #modal-content h1 { font-size: 2rem; }
        #modal-content h2 { font-size: 1.75rem; }
        #modal-content h3 { font-size: 1.5rem; }

        /* Paragraphs */
        #modal-content p {
            margin-bottom: 1.25em;
        }

        /* Code Blocks */
        #modal-content pre {
            background-color: #1E293B; /* Dark blue-gray background */
            color: #E2E8F0;
            padding: 1.25em;
            border-radius: 8px;
            overflow-x: auto;
            margin-bottom: 1.5em;
        }

        #modal-content pre code {
            background-color: transparent;
            padding: 0;
            font-size: 0.9em;
            color: inherit;
        }

        /* Inline Code */
        #modal-content code {
            background-color: #E5E7EB;
            color: #be123c;
            padding: 0.2em 0.4em;
            margin: 0 0.1em;
            font-size: 85%;
            border-radius: 4px;
        }

        /* Links */
        #modal-content a {
            color: #2563EB;
            text-decoration: underline;
            font-weight: 500;
        }
        #modal-content a:hover {
            color: #1D4ED8;
        }

        /* Lists */
        #modal-content ul, #modal-content ol {
            margin-left: 1.5em;
            margin-bottom: 1.25em;
            list-style-position: outside;
        }
        #modal-content li {
            margin-bottom: 0.5em;
        }

        h1.banner {
            background: #4CAF50;
            color: white;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }

        /* Styled Links */
        a {
            color: #1E90FF;
            text-decoration: none;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease-in-out;
        }
        a:hover {
            color: #374151;
            border-bottom: 2px solid #1E90FF;
        }
        body {
            font-family: 'Inter', sans-serif;
        }
        .card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-800 via-blue-900 to-emerald-800 min-h-screen text-gray-800">
    <div class="fixed inset-0 bg-gradient-to-r from-blue-600/20 via-emerald-600/20 to-teal-500/20 animate-pulse"></div>

    <header class="glass shadow-md sticky top-0 z-10 relative">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-900">My Blog</h1>
            <div class="flex items-center space-x-4">
                <div class="relative">
                    <input type="text" id="search" placeholder="Search articles..." class="border rounded-lg py-2 px-4 w-48 md:w-64 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <svg class="w-5 h-5 absolute right-3 top-2.5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
                <button id="admin-login-btn" class="glass p-2 rounded-lg hover:bg-white/20 transition-all duration-200 group" title="Admin Panel">
                    <svg class="w-5 h-5 text-gray-800 group-hover:text-gray-900" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 relative">
        <div id="blog-posts" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            </div>
    </main>

    <div id="article-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-20">
        <div class="bg-white rounded-lg shadow-xl w-11/12 md:w-3/4 lg:w-2/3 max-h-[90vh] overflow-y-auto">
            <div class="p-4 md:p-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="modal-title" class="text-2xl md:text-3xl font-bold"></h2>
                    <div class="flex items-center space-x-2">
                        <button id="modal-share" class="text-gray-500 hover:text-blue-500 p-2 rounded-lg transition-colors" title="Share Article">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6.002l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.368a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
                            </svg>
                        </button>
                        <button id="modal-close" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
                    </div>
                </div>
                <div id="modal-content" class="prose max-w-none"></div>
            </div>
        </div>
    </div>

    <div id="admin-login-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-20">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-4">Admin Login</h2>
            <form id="admin-login-form">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                    <input type="text" id="username" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" required>
                </div>
                <div class="flex items-center justify-between">
                    <button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600">Login</button>
                    <button type="button" id="admin-login-close" class="text-gray-500 hover:text-gray-800">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="force-password-change-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-20">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-2">Change Default Password</h2>
            <p class="text-sm text-gray-600 mb-4">For security, please change the default password.</p>
            <form id="force-password-change-form">
                <div class="mb-4">
                    <label for="new-password" class="block text-sm font-medium text-gray-700">New Password</label>
                    <input type="password" id="new-password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <div class="mb-6">
                    <label for="confirm-password" class="block text-sm font-medium text-gray-700">Confirm New Password</label>
                    <input type="password" id="confirm-password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                </div>
                <button type="submit" class="w-full bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600">Set New Password</button>
            </form>
        </div>
    </div>

    <div id="admin-panel" class="fixed inset-0 bg-gray-100 hidden z-20">
        <div class="flex h-full">
            <!-- Sidebar -->
            <div class="w-64 bg-white shadow-lg border-r border-gray-200">
                <!-- Header -->
                <div class="p-6 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-bold text-gray-800">Admin Panel</h2>
                        <button id="admin-panel-close" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                    </div>
                </div>
                
                <!-- Navigation -->
                <nav class="p-4">
                    <ul class="space-y-2">
                        <li>
                            <button class="sidebar-nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 transition-colors flex items-center" data-section="analytics">
                                <svg class="w-5 h-5 mr-3 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                                Analytics
                            </button>
                        </li>
                        <li>
                            <button class="sidebar-nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 transition-colors flex items-center" data-section="repositories">
                                <svg class="w-5 h-5 mr-3 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                </svg>
                                Repositories
                            </button>
                        </li>
                        <li>
                            <button class="sidebar-nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 transition-colors flex items-center" data-section="actions">
                                <svg class="w-5 h-5 mr-3 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                                Actions
                            </button>
                        </li>
                        <li>
                            <button class="sidebar-nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 transition-colors flex items-center" data-section="blog-settings">
                                <svg class="w-5 h-5 mr-3 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                                </svg>
                                Blog Settings
                            </button>
                        </li>
                        <li>
                            <button class="sidebar-nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 transition-colors flex items-center" data-section="security">
                                <svg class="w-5 h-5 mr-3 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                </svg>
                                Security
                            </button>
                        </li>
                        <li>
                            <button class="sidebar-nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 transition-colors flex items-center" data-section="ai-services">
                                <svg class="w-5 h-5 mr-3 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                </svg>
                                AI Services
                            </button>
                        </li>
                        <li>
                            <button class="sidebar-nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-gray-50 transition-colors flex items-center" data-section="social-media">
                                <svg class="w-5 h-5 mr-3 text-cyan-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6.002l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.368a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
                                </svg>
                                Social Media
                            </button>
                        </li>
                    </ul>
                </nav>
            </div>
            
            <!-- Main Content -->
            <div class="flex-1 overflow-y-auto">
                <div class="p-8">
                    <!-- Content sections will be shown/hidden based on sidebar selection -->
                    
                    <!-- Analytics Section -->
                    <div id="section-analytics" class="admin-section hidden">
                        <h3 class="text-2xl font-bold mb-6 text-gray-800">Analytics Overview</h3>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <div id="analytics-container">
                                <button id="load-analytics-btn" class="bg-indigo-500 text-white py-2 px-4 rounded-lg hover:bg-indigo-600 mb-4">
                                    Load Analytics Data
                                </button>
                                <div id="analytics-data" class="hidden">
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                        <div class="bg-blue-50 p-4 rounded-lg text-center">
                                            <div class="text-2xl font-bold text-blue-600" id="total-hits">0</div>
                                            <div class="text-sm text-gray-600">Total Hits</div>
                                        </div>
                                        <div class="bg-green-50 p-4 rounded-lg text-center">
                                            <div class="text-2xl font-bold text-green-600" id="unique-visitors">0</div>
                                            <div class="text-sm text-gray-600">Unique Visitors</div>
                                        </div>
                                        <div class="bg-purple-50 p-4 rounded-lg text-center">
                                            <div class="text-2xl font-bold text-purple-600" id="top-article-views">0</div>
                                            <div class="text-sm text-gray-600">Top Article Views</div>
                                        </div>
                                        <div class="bg-orange-50 p-4 rounded-lg text-center">
                                            <div class="text-2xl font-bold text-orange-600" id="countries-count">0</div>
                                            <div class="text-sm text-gray-600">Countries</div>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <!-- Top Articles -->
                                        <div class="bg-gray-50 p-4 rounded-lg">
                                            <h4 class="font-semibold mb-3 text-gray-800">Top Articles</h4>
                                            <div id="top-articles-list" class="space-y-2 max-h-64 overflow-y-auto">
                                                <!-- Articles will be populated here -->
                                            </div>
                                        </div>
                                        
                                        <!-- Top Countries -->
                                        <div class="bg-gray-50 p-4 rounded-lg">
                                            <h4 class="font-semibold mb-3 text-gray-800">Top Countries</h4>
                                            <div id="top-countries-list" class="space-y-2 max-h-64 overflow-y-auto">
                                                <!-- Countries will be populated here -->
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Recent Activity Chart -->
                                    <div class="mt-6 bg-gray-50 p-4 rounded-lg">
                                        <h4 class="font-semibold mb-3 text-gray-800">Recent Activity (Last 30 Days)</h4>
                                        <div id="daily-stats-chart" class="h-64 overflow-x-auto">
                                            <!-- Chart will be rendered here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Repositories Section -->
                    <div id="section-repositories" class="admin-section hidden">
                        <h3 class="text-2xl font-bold mb-6 text-gray-800">Manage Repositories</h3>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <form id="add-repo-form" class="flex items-center space-x-2 mb-6">
                                <input type="text" id="repo-url" placeholder="e.g., username/repository" class="border rounded-lg py-2 px-4 flex-1 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <button type="submit" class="bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 whitespace-nowrap">Add Repo</button>
                            </form>
                            <div id="repo-list"></div>
                        </div>
                    </div>
                    
                    <!-- Actions Section -->
                    <div id="section-actions" class="admin-section hidden">
                        <h3 class="text-2xl font-bold mb-6 text-gray-800">Blog Actions</h3>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <div class="space-y-3">
                                <button id="scan-btn" class="bg-blue-500 text-white py-2 px-6 rounded-lg hover:bg-blue-600 flex items-center justify-center w-full">
                                    <span id="scan-btn-text">Scan for New Articles</span>
                                    <span id="scan-spinner" class="hidden animate-spin">&#9696;</span>
                                </button>
                                <button id="rescan-btn" class="bg-orange-500 text-white py-2 px-6 rounded-lg hover:bg-orange-600 flex items-center justify-center w-full">
                                    <span id="rescan-btn-text">Rescan Repositories</span>
                                    <span id="rescan-spinner" class="hidden animate-spin">&#9696;</span>
                                </button>
                                <button id="regenerate-images-btn" class="bg-purple-500 text-white py-2 px-6 rounded-lg hover:bg-purple-600 flex items-center justify-center w-full">
                                    <span id="regenerate-btn-text">Regenerate All Images</span>
                                    <span id="regenerate-spinner" class="hidden animate-spin">&#9696;</span>
                                </button>
                                <div id="regenerate-progress" class="hidden mt-3">
                                    <div class="flex justify-between text-sm text-gray-600 mb-1">
                                        <span id="progress-text">Processing images...</span>
                                        <span id="progress-count">0/0</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div id="progress-bar" class="bg-purple-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Blog Settings Section -->
                    <div id="section-blog-settings" class="admin-section hidden">
                        <h3 class="text-2xl font-bold mb-6 text-gray-800">Blog Settings</h3>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <form id="blog-name-form" class="flex items-center space-x-2">
                                <input type="text" id="blog-name-input" placeholder="Enter new blog name" class="border rounded-lg py-2 px-4 flex-1 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <button type="submit" class="bg-purple-500 text-white py-2 px-4 rounded-lg hover:bg-purple-600 whitespace-nowrap">Update Name</button>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Security Section -->
                    <div id="section-security" class="admin-section hidden">
                        <h3 class="text-2xl font-bold mb-6 text-gray-800">Security Settings</h3>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h4 class="text-lg font-semibold mb-4">Change Password</h4>
                            <form id="change-password-form">
                                <div class="mb-4">
                                    <label for="current-password-admin" class="block text-sm font-medium text-gray-700">Current Password</label>
                                    <input type="password" id="current-password-admin" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                                </div>
                                <div class="mb-4">
                                    <label for="new-password-admin" class="block text-sm font-medium text-gray-700">New Password</label>
                                    <input type="password" id="new-password-admin" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                                </div>
                                <div class="mb-6">
                                    <label for="confirm-password-admin" class="block text-sm font-medium text-gray-700">Confirm New Password</label>
                                    <input type="password" id="confirm-password-admin" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                                </div>
                                <button type="submit" class="w-full bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600">Update Password</button>
                            </form>
                        </div>
                    </div>
                    
                    <!-- AI Services Section -->
                    <div id="section-ai-services" class="admin-section hidden">
                        <h3 class="text-2xl font-bold mb-6 text-gray-800">AI Services</h3>
                        <div class="space-y-6">
                            <!-- OpenAI Configuration -->
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h4 class="text-lg font-semibold mb-4">OpenAI API Configuration</h4>
                                <div class="mb-4">
                                    <div class="flex items-center space-x-2">
                                        <span class="text-sm text-gray-600">Status:</span>
                                        <span id="openai-status" class="px-2 py-1 rounded-full text-xs font-medium">Checking...</span>
                                    </div>
                                </div>
                                <form id="openai-api-form">
                                    <div class="mb-4">
                                        <label for="openai-api-key" class="block text-sm font-medium text-gray-700">OpenAI API Key</label>
                                        <div class="relative">
                                            <input type="password" id="openai-api-key" placeholder="Enter your OpenAI API key" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm pr-10" required>
                                            <button type="button" id="toggle-openai-password" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600">
                                                <svg id="openai-eye-open" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 616 0z"></path>
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                                </svg>
                                                <svg id="openai-eye-closed" class="h-5 w-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
                                                </svg>
                                            </button>
                                        </div>
                                        <p class="mt-1 text-xs text-gray-500">Primary image generation service using DALL-E. Get your key from <a href="https://platform.openai.com/api-keys" target="_blank" class="text-blue-500 hover:underline">OpenAI Platform</a>.</p>
                                    </div>
                                    <button type="submit" class="w-full bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600">Save API Key</button>
                                </form>
                            </div>
                            
                            <!-- Gemini Configuration -->
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h4 class="text-lg font-semibold mb-4">Gemini API Configuration</h4>
                                <div class="mb-4">
                                    <div class="flex items-center space-x-2">
                                        <span class="text-sm text-gray-600">Status:</span>
                                        <span id="gemini-status" class="px-2 py-1 rounded-full text-xs font-medium">Checking...</span>
                                    </div>
                                </div>
                                <form id="gemini-api-form">
                                    <div class="mb-4">
                                        <label for="gemini-api-key" class="block text-sm font-medium text-gray-700">Gemini API Key</label>
                                        <div class="relative">
                                            <input type="password" id="gemini-api-key" placeholder="Enter your Gemini API key" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm pr-10" required>
                                            <button type="button" id="toggle-gemini-password" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600">
                                                <svg id="eye-open" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 616 0z"></path>
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                                </svg>
                                                <svg id="eye-closed" class="h-5 w-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
                                                </svg>
                                            </button>
                                        </div>
                                        <p class="mt-1 text-xs text-gray-500">Fallback image generation service. Get your key from <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-500 hover:underline">Google AI Studio</a>.</p>
                                    </div>
                                    <button type="submit" class="w-full bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600">Save API Key</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Social Media Section -->
                    <div id="section-social-media" class="admin-section hidden">
                        <h3 class="text-2xl font-bold mb-6 text-gray-800">Social Media Integration</h3>
                        <div class="space-y-6">
                            <!-- Bluesky Integration -->
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <div class="flex items-center mb-4">
                                    <svg class="w-6 h-6 text-blue-500 mr-2" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                    </svg>
                                    <h4 class="text-lg font-semibold">🦋 Bluesky Integration</h4>
                                </div>
                                
                                <!-- Status Display -->
                                <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="flex items-center space-x-2">
                                                <span class="text-sm font-medium text-gray-700">Status:</span>
                                                <span id="bluesky-status" class="px-2 py-1 rounded-full text-xs font-medium">Checking...</span>
                                            </div>
                                            <div class="mt-1">
                                                <span class="text-sm text-gray-600">Handle:</span>
                                                <span id="bluesky-handle-display" class="text-sm font-mono">Not configured</span>
                                            </div>
                                        </div>
                                        <button id="test-bluesky-connection" class="bg-blue-500 text-white py-1 px-3 rounded text-sm hover:bg-blue-600 disabled:opacity-50" disabled>
                                            Test Connection
                                        </button>
                                    </div>
                                </div>

                                <!-- Configuration Form -->
                                <form id="bluesky-config-form">
                                    <div class="mb-4">
                                        <label for="bluesky-handle" class="block text-sm font-medium text-gray-700 mb-2">
                                            Bluesky Handle
                                            <span class="text-red-500">*</span>
                                        </label>
                                        <input type="text" id="bluesky-handle" placeholder="username.bsky.social" 
                                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                                        <p class="mt-1 text-xs text-gray-500">
                                            Your Bluesky username (e.g., yourname.bsky.social or your custom domain)
                                        </p>
                                    </div>

                                    <div class="mb-4">
                                        <label for="bluesky-app-password" class="block text-sm font-medium text-gray-700 mb-2">
                                            App Password
                                            <span class="text-red-500">*</span>
                                        </label>
                                        <div class="relative">
                                            <input type="password" id="bluesky-app-password" placeholder="Enter your Bluesky app password" 
                                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm pr-10 focus:ring-blue-500 focus:border-blue-500" required>
                                            <button type="button" id="toggle-bluesky-password" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600">
                                                <svg id="bluesky-eye-open" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 616 0z"></path>
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                                </svg>
                                                <svg id="bluesky-eye-closed" class="h-5 w-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
                                                </svg>
                                            </button>
                                        </div>
                                        <p class="mt-1 text-xs text-gray-500">
                                            ⚠️ <strong>Not your account password!</strong> Create an app password in Bluesky settings.
                                        </p>
                                    </div>

                                    <button type="submit" class="w-full bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 mb-4">
                                        Save Bluesky Configuration
                                    </button>
                                </form>

                                <!-- Setup Instructions -->
                                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                                    <div class="flex">
                                        <div class="flex-shrink-0">
                                            <svg class="h-5 w-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                            </svg>
                                        </div>
                                        <div class="ml-3">
                                            <h4 class="text-sm font-medium text-yellow-800">Setup Instructions</h4>
                                            <div class="mt-2 text-sm text-yellow-700">
                                                <ol class="list-decimal list-inside space-y-1">
                                                    <li>Go to <a href="https://bsky.app/settings/app-passwords" target="_blank" class="text-blue-600 hover:underline font-medium">Bluesky App Passwords</a></li>
                                                    <li>Click "Add App Password"</li>
                                                    <li>Name it "SimpleBlog" or similar</li>
                                                    <li>Copy the generated password and paste it above</li>
                                                    <li>Save your configuration and test the connection</li>
                                                </ol>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Cross-posting Actions -->
                                <div id="bluesky-actions" class="hidden">
                                    <div class="border-t pt-4">
                                        <h4 class="font-medium text-gray-900 mb-3">🚀 Cross-posting Actions</h4>
                                        <div class="space-y-2">
                                            <button id="post-latest-article-btn" class="w-full bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 flex items-center justify-center">
                                                <span id="post-latest-text">Post Latest Article to Bluesky</span>
                                                <span id="post-latest-spinner" class="hidden animate-spin ml-2">⏳</span>
                                            </button>
                                            <button id="bulk-post-articles-btn" class="w-full bg-indigo-500 text-white py-2 px-4 rounded-lg hover:bg-indigo-600 flex items-center justify-center">
                                                <span id="bulk-post-text">Post All Recent Articles</span>
                                                <span id="bulk-post-spinner" class="hidden animate-spin ml-2">⏳</span>
                                            </button>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-2">
                                            💡 Tip: After posting, you can track engagement stats for each article!
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Fediverse/Mastodon Integration -->
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <div class="flex items-center mb-4">
                                    <svg class="w-6 h-6 text-purple-500 mr-2" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M23.268 5.313c-.35-2.578-2.617-4.61-5.304-5.004C17.51.242 15.792 0 11.813 0h-.03c-3.98 0-4.835.242-5.288.309C3.882.692 1.496 2.518.917 5.127.64 6.412.61 7.837.661 9.143c.074 1.874.088 3.745.26 5.611.118 1.24.325 2.47.594 3.681.433 1.934 1.178 3.676 2.37 5.183 1.207 1.529 2.809 2.471 4.668 2.886 1.16.258 2.354.196 3.518.084 2.102-.2 4.002-.914 5.6-2.314.08-.07.155-.145.22-.225.9-1.1 1.505-2.378 1.837-3.744.264-1.084.42-2.19.420-3.327 0-.249-.007-.497-.019-.744-.024-.477-.058-.952-.108-1.426-.025-.234-.06-.467-.101-.698-.082-.463-.2-.917-.367-1.357-.334-.882-.814-1.714-1.443-2.447-.629-.733-1.392-1.36-2.243-1.877-.426-.259-.873-.482-1.347-.67-.237-.094-.48-.176-.728-.248-.496-.144-1.006-.218-1.516-.218-.17 0-.341.008-.511.024-.34.032-.675.08-1.004.144-.33.064-.654.144-.97.24-.316.096-.625.208-.925.336-.6.256-1.17.58-1.686.964-.516.384-.976.818-1.363 1.295-.387.477-.698 1-.915 1.554-.217.554-.338 1.138-.338 1.732 0 .594.121 1.178.338 1.732.217.554.528 1.077.915 1.554.387.477.847.911 1.363 1.295.516.384 1.086.708 1.686.964.3.128.609.24.925.336.316.096.64.176.97.24.329.064.664.112 1.004.144.17.016.341.024.511.024.51 0 1.02-.074 1.516-.218.248-.072.491-.154.728-.248.474-.188.921-.411 1.347-.67.851-.517 1.614-1.144 2.243-1.877.629-.733 1.109-1.565 1.443-2.447.167-.44.285-.894.367-1.357.041-.231.076-.464.101-.698.05-.474.084-.949.108-1.426.012-.247.019-.495.019-.744 0-1.137-.156-2.243-.42-3.327-.332-1.366-.937-2.644-1.837-3.744-.065-.08-.14-.155-.22-.225-1.598-1.4-3.498-2.114-5.6-2.314-1.164-.112-2.358-.174-3.518.084-1.859.415-3.461 1.357-4.668 2.886-1.192 1.507-1.937 3.249-2.37 5.183-.269 1.211-.476 2.441-.594 3.681-.172 1.866-.186 3.737-.26 5.611-.051 1.306-.021 2.731.256 4.016.579 2.609 2.965 4.435 5.608 4.824.453.067 1.308.309 5.288.309h.03c3.979 0 5.697-.242 6.15-.309 2.687-.394 4.954-2.426 5.304-5.004.63-4.639.63-4.639.63-4.639s0-5.21-.63-9.849z"/>
                                    </svg>
                                    <h4 class="text-lg font-semibold">🐘 Fediverse Integration</h4>
                                </div>
                                
                                <!-- Status Display -->
                                <div class="mb-4 p-4 bg-purple-50 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="flex items-center space-x-2">
                                                <span class="text-sm font-medium text-gray-700">Status:</span>
                                                <span id="fediverse-status" class="px-2 py-1 rounded-full text-xs font-medium">Checking...</span>
                                            </div>
                                            <div class="mt-1">
                                                <span class="text-sm text-gray-600">Instance:</span>
                                                <span id="fediverse-instance-display" class="text-sm font-mono">Not configured</span>
                                            </div>
                                            <div class="mt-1">
                                                <span class="text-sm text-gray-600">Username:</span>
                                                <span id="fediverse-username-display" class="text-sm font-mono">Not configured</span>
                                            </div>
                                        </div>
                                        <button id="test-fediverse-connection" class="bg-purple-500 text-white py-1 px-3 rounded text-sm hover:bg-purple-600 disabled:opacity-50" disabled>
                                            Test Connection
                                        </button>
                                    </div>
                                </div>

                                <!-- Configuration Form -->
                                <form id="fediverse-config-form">
                                    <div class="mb-4">
                                        <label for="fediverse-instance" class="block text-sm font-medium text-gray-700 mb-2">
                                            Mastodon/Fediverse Instance URL
                                            <span class="text-red-500">*</span>
                                        </label>
                                        <input type="url" id="fediverse-instance" placeholder="https://mastodon.social" 
                                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-purple-500 focus:border-purple-500" required>
                                        <p class="mt-1 text-xs text-gray-500">
                                            Your Mastodon instance URL (e.g., https://mastodon.social, https://fosstodon.org)
                                        </p>
                                    </div>

                                    <div class="mb-4">
                                        <label for="fediverse-username" class="block text-sm font-medium text-gray-700 mb-2">
                                            Username
                                            <span class="text-red-500">*</span>
                                        </label>
                                        <input type="text" id="fediverse-username" placeholder="your_username" 
                                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-purple-500 focus:border-purple-500" required>
                                        <p class="mt-1 text-xs text-gray-500">
                                            Your username without the @ symbol or instance domain
                                        </p>
                                    </div>

                                    <div class="mb-4">
                                        <label for="fediverse-access-token" class="block text-sm font-medium text-gray-700 mb-2">
                                            Access Token
                                            <span class="text-red-500">*</span>
                                        </label>
                                        <div class="relative">
                                            <input type="password" id="fediverse-access-token" placeholder="Enter your access token" 
                                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm pr-10 focus:ring-purple-500 focus:border-purple-500" required>
                                            <button type="button" id="toggle-fediverse-password" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600">
                                                <svg id="fediverse-eye-open" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 616 0z"></path>
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                                </svg>
                                                <svg id="fediverse-eye-closed" class="h-5 w-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
                                                </svg>
                                            </button>
                                        </div>
                                        <p class="mt-1 text-xs text-gray-500">
                                            ⚠️ <strong>Keep this secure!</strong> Generate an access token in your instance's developer settings.
                                        </p>
                                    </div>

                                    <button type="submit" class="w-full bg-purple-500 text-white py-2 px-4 rounded-lg hover:bg-purple-600 mb-4">
                                        Save Fediverse Configuration
                                    </button>
                                </form>

                                <!-- Setup Instructions -->
                                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                                    <div class="flex">
                                        <div class="flex-shrink-0">
                                            <svg class="h-5 w-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                            </svg>
                                        </div>
                                        <div class="ml-3">
                                            <h4 class="text-sm font-medium text-yellow-800">Setup Instructions</h4>
                                            <div class="mt-2 text-sm text-yellow-700">
                                                <ol class="list-decimal list-inside space-y-1">
                                                    <li>Go to your Mastodon instance (e.g. mastodon.social/settings/applications)</li>
                                                    <li>Click "New Application" or "Development"</li>
                                                    <li>Name it "SimpleBlog" and set scopes to "write:statuses"</li>
                                                    <li>Copy your instance URL, username, and access token above</li>
                                                    <li>Save your configuration and test the connection</li>
                                                </ol>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Cross-posting Actions -->
                                <div id="fediverse-actions" class="hidden">
                                    <div class="border-t pt-4">
                                        <h4 class="font-medium text-gray-900 mb-3">🚀 Cross-posting Actions</h4>
                                        <div class="space-y-2">
                                            <button id="post-latest-article-fediverse-btn" class="w-full bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 flex items-center justify-center">
                                                <span id="post-latest-fediverse-text">Post Latest Article to Fediverse</span>
                                                <span id="post-latest-fediverse-spinner" class="hidden animate-spin ml-2">⏳</span>
                                            </button>
                                            <button id="bulk-post-articles-fediverse-btn" class="w-full bg-indigo-500 text-white py-2 px-4 rounded-lg hover:bg-indigo-600 flex items-center justify-center">
                                                <span id="bulk-post-fediverse-text">Post All Recent Articles</span>
                                                <span id="bulk-post-fediverse-spinner" class="hidden animate-spin ml-2">⏳</span>
                                            </button>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-2">
                                            💡 Tip: Posts will include hashtags and links back to your blog!
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURATION ---
            const ADMIN_USERNAME = 'admin';
            const DEFAULT_PASSWORD = 'password';

            // --- DOM ELEMENTS ---
            const blogPostsContainer = document.getElementById('blog-posts');
            const searchInput = document.getElementById('search');
            // Modals
            const articleModal = document.getElementById('article-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            const modalCloseBtn = document.getElementById('modal-close');
            // Admin Login
            const adminLoginBtn = document.getElementById('admin-login-btn');
            const adminLoginModal = document.getElementById('admin-login-modal');
            const adminLoginForm = document.getElementById('admin-login-form');
            const adminLoginCloseBtn = document.getElementById('admin-login-close');
            // Force Password Change
            const forcePasswordChangeModal = document.getElementById('force-password-change-modal');
            const forcePasswordChangeForm = document.getElementById('force-password-change-form');
            // Admin Panel
            const adminPanel = document.getElementById('admin-panel');
            const adminPanelCloseBtn = document.getElementById('admin-panel-close');
            const addRepoForm = document.getElementById('add-repo-form');
            const repoUrlInput = document.getElementById('repo-url');
            const repoListContainer = document.getElementById('repo-list');
            const scanBtn = document.getElementById('scan-btn');
            const scanBtnText = document.getElementById('scan-btn-text');
            const scanSpinner = document.getElementById('scan-spinner');
            const rescanBtn = document.getElementById('rescan-btn');
            const rescanBtnText = document.getElementById('rescan-btn-text');
            const rescanSpinner = document.getElementById('rescan-spinner');
            const regenerateImagesBtn = document.getElementById('regenerate-images-btn');
            const regenerateBtnText = document.getElementById('regenerate-btn-text');
            const regenerateSpinner = document.getElementById('regenerate-spinner');
            const regenerateProgress = document.getElementById('regenerate-progress');
            const progressText = document.getElementById('progress-text');
            const progressCount = document.getElementById('progress-count');
            const progressBar = document.getElementById('progress-bar');
            const blogNameForm = document.getElementById('blog-name-form');
            const blogNameInput = document.getElementById('blog-name-input');
            const blogTitleElement = document.querySelector('header h1');
            const changePasswordForm = document.getElementById('change-password-form');
            // OpenAI API elements
            const openaiApiForm = document.getElementById('openai-api-form');
            const openaiApiKeyInput = document.getElementById('openai-api-key');
            const openaiStatusElement = document.getElementById('openai-status');
            const toggleOpenaiPasswordBtn = document.getElementById('toggle-openai-password');
            // Gemini API elements
            const geminiApiForm = document.getElementById('gemini-api-form');
            const geminiApiKeyInput = document.getElementById('gemini-api-key');
            const geminiStatusElement = document.getElementById('gemini-status');
            const toggleGeminiPasswordBtn = document.getElementById('toggle-gemini-password');
            // Analytics elements
            const loadAnalyticsBtn = document.getElementById('load-analytics-btn');
            const analyticsData = document.getElementById('analytics-data');
            const totalHitsEl = document.getElementById('total-hits');
            const uniqueVisitorsEl = document.getElementById('unique-visitors');
            const topArticleViewsEl = document.getElementById('top-article-views');
            const countriesCountEl = document.getElementById('countries-count');
            const topArticlesList = document.getElementById('top-articles-list');
            const topCountriesList = document.getElementById('top-countries-list');
            const dailyStatsChart = document.getElementById('daily-stats-chart');
            // Bluesky elements
            const blueskyConfigForm = document.getElementById('bluesky-config-form');
            const blueskyHandleInput = document.getElementById('bluesky-handle');
            const blueskyAppPasswordInput = document.getElementById('bluesky-app-password');
            const blueskyStatusElement = document.getElementById('bluesky-status');
            const blueskyHandleDisplay = document.getElementById('bluesky-handle-display');
            const testBlueskyConnectionBtn = document.getElementById('test-bluesky-connection');
            const toggleBlueskyPasswordBtn = document.getElementById('toggle-bluesky-password');
            const blueskyActions = document.getElementById('bluesky-actions');
            const postLatestArticleBtn = document.getElementById('post-latest-article-btn');
            const bulkPostArticlesBtn = document.getElementById('bulk-post-articles-btn');
            // Fediverse elements
            const fediverseConfigForm = document.getElementById('fediverse-config-form');
            const fediverseInstanceInput = document.getElementById('fediverse-instance');
            const fediverseUsernameInput = document.getElementById('fediverse-username');
            const fediverseAccessTokenInput = document.getElementById('fediverse-access-token');
            const fediverseStatusElement = document.getElementById('fediverse-status');
            const fediverseInstanceDisplay = document.getElementById('fediverse-instance-display');
            const fediverseUsernameDisplay = document.getElementById('fediverse-username-display');
            const testFediverseConnectionBtn = document.getElementById('test-fediverse-connection');
            const toggleFediversePasswordBtn = document.getElementById('toggle-fediverse-password');
            const fediverseActions = document.getElementById('fediverse-actions');
            const postLatestArticleFediverseBtn = document.getElementById('post-latest-article-fediverse-btn');
            const bulkPostArticlesFediverseBtn = document.getElementById('bulk-post-articles-fediverse-btn');

            // --- STATE MANAGEMENT ---
            let allPosts = [];
            let repositories = [];
            let isLoggedIn = false;
            let blogConfig = {};
            
            // Check authentication status on load
            async function checkAuthStatus() {
                try {
                    const response = await fetch('/api/auth/status');
                    const data = await response.json();
                    isLoggedIn = data.authenticated;
                } catch (error) {
                    console.error('Error checking auth status:', error);
                    isLoggedIn = false;
                }
            }

            // Load public configuration (available to all visitors)
            async function loadPublicConfig() {
                try {
                    const response = await fetch('/api/public/config');
                    if (response.ok) {
                        blogConfig = await response.json();
                        repositories = blogConfig.repositories || [];
                        updateBlogName();
                        renderRepos();
                    }
                } catch (error) {
                    console.error('Error loading public config:', error);
                }
            }

            // Load full configuration (admin only)
            async function loadConfig() {
                try {
                    const response = await fetch('/api/config');
                    if (response.ok) {
                        blogConfig = await response.json();
                        repositories = blogConfig.repositories || [];
                        updateBlogName();
                        renderRepos();
                        updateGeminiStatus();
                        updateOpenaiStatus();
                        updateBlueskyStatus();
                        updateFediverseStatus();
                    }
                } catch (error) {
                    console.error('Error loading config:', error);
                }
            }

            // --- GITHUB API ---
            const converter = new showdown.Converter();

            async function fetchFromGitHub(url, bustCache = false) {
                try {
                    // Add cache-busting parameter to force fresh data
                    const fetchUrl = bustCache ? `${url}${url.includes('?') ? '&' : '?'}_cb=${Date.now()}` : url;
                    
                    // Don't add custom headers to avoid CORS issues with GitHub API
                    const response = await fetch(fetchUrl);
                    
                    if (!response.ok) {
                        throw new Error(`GitHub API request failed: ${response.statusText}`);
                    }
                    return response.json();
                } catch (error) {
                    console.error("Fetch error:", error);
                    alert("Could not connect to GitHub. Please check your internet connection.");
                    return null; // Return null to handle the error gracefully
                }
            }

            async function getArticlesFromRepo(repoName, bustCache = false) {
                const posts = [];
                try {
                    console.log(`Fetching from repo: ${repoName} (bust cache: ${bustCache})`);
                    const contents = await fetchFromGitHub(`https://api.github.com/repos/${repoName}/contents`, bustCache);
                     if (!contents) return []; // If fetch failed, return empty array
                    await Promise.all(contents.map(item => processRepoItem(item, repoName, posts, '', bustCache)));
                } catch (error) {
                    console.error(`Error fetching from repo ${repoName}:`, error);
                    alert(`Failed to fetch articles from ${repoName}. Check the repository path and permissions.`);
                }
                return posts;
            }

            async function processRepoItem(item, repoName, posts, currentPath = '', bustCache = false) {
                const path = currentPath ? `${currentPath}/${item.name}` : item.name;
                if (item.type === 'dir') {
                    const contents = await fetchFromGitHub(item.url, bustCache);
                     if (!contents) return;
                    await Promise.all(contents.map(newItem => processRepoItem(newItem, repoName, posts, path, bustCache)));
                } else if (item.name.endsWith('.md') && item.download_url) {
                    try {
                        // Add cache-busting for file content as well
                        const fileUrl = bustCache ? `${item.download_url}?_cb=${Date.now()}` : item.download_url;
                        console.log(`Fetching file: ${path} (bust cache: ${bustCache})`);
                        
                        // Don't add custom headers to avoid CORS issues with GitHub raw content
                        const response = await fetch(fileUrl);
                        const fileContent = await response.text();

                        // Use the filename as a fallback title
                        let title = item.name.replace(/\.md$/, '');
                        let markdownContent = fileContent;

                        // Check if the first non-empty line is an H1 heading
                        const lines = fileContent.split('\n');
                        const firstLineIndex = lines.findIndex(line => line.trim() !== '');
                        const firstLine = firstLineIndex !== -1 ? lines[firstLineIndex].trim() : '';

                        if (firstLine.startsWith('# ')) {
                            // If it is, use it as the title
                            title = firstLine.substring(2).trim();
                            // And remove that line from the rest of the content
                            lines.splice(firstLineIndex, 1);
                            markdownContent = lines.join('\n');
                        }

                        const htmlContent = converter.makeHtml(markdownContent);
                        const pathParts = path.split('/');
                        const tag = pathParts.length > 1 ? pathParts[pathParts.length - 2] : 'general';

                        posts.push({
                            title: title,
                            content: htmlContent,
                            tag: tag,
                            repo: repoName,
                            path: path,
                            likes: parseInt(localStorage.getItem(`like_${path}`) || '0'),
                            imageUrl: null // Will be populated during image generation
                        });
                    } catch (error) {
                        console.warn(`Could not fetch content for ${path}:`, error);
                    }
                }
            }


            // --- UI RENDERING ---
            function renderPosts(postsToRender) {
                blogPostsContainer.innerHTML = '';
                if (postsToRender.length === 0) {
                    blogPostsContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">No articles found. Try scanning for new articles in the admin panel.</p>';
                    return;
                }
                postsToRender.forEach(post => {
                    const postCard = document.createElement('div');
                    postCard.className = 'card glass overflow-hidden cursor-pointer';
                    postCard.innerHTML = `
                        <div class="p-6">
                            <img src="${post.imageUrl || '/static/default-thumbnail.svg'}" alt="${post.title}" class="w-full h-48 object-cover object-center mb-2 rounded-t-lg">
                            <span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full">${post.tag}</span>
                            <h3 class="text-xl font-bold mt-2 mb-2 text-white">${post.title}</h3>
                            <div class="text-white h-20 overflow-hidden">${truncateHTML(post.content, 100)}</div>
                        </div>
                        <div class="p-6 bg-gray-50 flex justify-between items-center">
                            <div class="flex space-x-4">
                                <button data-path="${post.path}" class="like-btn flex items-center space-x-1 text-gray-500 hover:text-red-500">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path></svg>
                                    <span class="like-count">${post.likes}</span>
                                </button>
                                <button data-title="${post.title}" data-path="${post.path}" class="share-btn flex items-center space-x-1 text-gray-500 hover:text-blue-500">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6.002l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.368a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path></svg>
                                    <span>Share</span>
                                </button>
                            </div>
                            <button class="read-more-btn text-blue-500 hover:underline">Read More</button>
                        </div>
                    `;
                    postCard.querySelector('.read-more-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        openArticleModal(post);
                    });
                     postCard.addEventListener('click', () => openArticleModal(post));
                    blogPostsContainer.appendChild(postCard);
                });
            }

            function truncateHTML(html, length) {
                const div = document.createElement('div');
                div.innerHTML = html;
                let text = div.textContent || div.innerText || "";
                return text.length > length ? text.substring(0, length) + "..." : text;
            }

            function renderRepos() {
                repoListContainer.innerHTML = '';
                repositories.forEach((repo, index) => {
                    const repoEl = document.createElement('div');
                    repoEl.className = 'flex justify-between items-center bg-gray-100 p-2 rounded-md mt-2';
                    repoEl.innerHTML = `
                        <span>${repo}</span>
                        <button data-index="${index}" class="remove-repo-btn text-red-500 hover:text-red-700 font-bold">Remove</button>
                    `;
                    repoListContainer.appendChild(repoEl);
                });
            }

            function updateBlogName() {
                if (blogConfig.blog_name) {
                    blogTitleElement.textContent = blogConfig.blog_name;
                    blogNameInput.value = blogConfig.blog_name;
                }
            }

            function updateGeminiStatus() {
                if (blogConfig.has_gemini_api_key) {
                    geminiStatusElement.textContent = 'Configured';
                    geminiStatusElement.className = 'px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800';
                } else {
                    geminiStatusElement.textContent = 'Not Configured';
                    geminiStatusElement.className = 'px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800';
                }
            }

            function updateOpenaiStatus() {
                if (blogConfig.has_openai_api_key) {
                    openaiStatusElement.textContent = 'Configured';
                    openaiStatusElement.className = 'px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800';
                } else {
                    openaiStatusElement.textContent = 'Not Configured';
                    openaiStatusElement.className = 'px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800';
                }
            }


            // --- EVENT HANDLERS ---
            function handleSearch() {
                const query = searchInput.value.toLowerCase();
                const filteredPosts = allPosts.filter(post =>
                    post.title.toLowerCase().includes(query) ||
                    post.tag.toLowerCase().includes(query) ||
                    post.content.toLowerCase().includes(query)
                );
                renderPosts(filteredPosts);
            }

            function handleLike(e) {
                const button = e.target.closest('.like-btn');
                if (!button) return;
                const path = button.dataset.path;
                const post = allPosts.find(p => p.path === path);
                if (post) {
                    post.likes++;
                    localStorage.setItem(`like_${path}`, post.likes);
                    button.querySelector('.like-count').textContent = post.likes;
                }
            }

            async function handleShare(e) {
                const button = e.target.closest('.share-btn');
                if (!button) return;
                const postTitle = button.dataset.title;
                const postPath = button.dataset.path;
                // Create a unique URL for this article by adding a hash fragment
                const articleUrl = `${window.location.origin}${window.location.pathname}#article-${encodeURIComponent(postPath)}`;
                
                if (navigator.share) {
                    try {
                        await navigator.share({
                            title: postTitle,
                            text: `Check out this article: ${postTitle}`,
                            url: articleUrl,
                        });
                    } catch (error) {
                        console.error('Error sharing:', error);
                    }
                } else {
                    navigator.clipboard.writeText(articleUrl).then(() => {
                        alert('Article link copied to clipboard!');
                    });
                }
            }

            async function scanForArticles() {
                scanBtn.disabled = true;
                scanSpinner.classList.remove('hidden');
                scanBtnText.classList.add('hidden');

                let newAllPosts = [];
                for (const repo of repositories) {
                    const posts = await getArticlesFromRepo(repo, false); // Regular scan doesn't bust cache
                    newAllPosts = newAllPosts.concat(posts);
                }
                allPosts = newAllPosts;
                
                // Save articles to server database
                try {
                    const saveResponse = await fetch('/api/save-articles', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(allPosts)
                    });
                    if (saveResponse.ok) {
                        console.log('Articles saved to database successfully');
                    }
                } catch (error) {
                    console.error('Failed to save articles to database:', error);
                }
                
                // Generate images for articles without images
                for (let post of allPosts) {
                    if (!post.imageUrl) {
                        const response = await fetch('/api/generate-image', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ title: post.title })
                        });

                        if (response.ok) {
                            const data = await response.json();
                            post.imageUrl = data.image_url;
                        }
                    }
                }

                renderPosts(allPosts);

                scanBtn.disabled = false;
                scanSpinner.classList.add('hidden');
                scanBtnText.classList.remove('hidden');
            }

            async function rescanRepositories() {
                if (!confirm('This will clear ALL existing articles and completely rescan all repositories. This action cannot be undone. Continue?')) {
                    return;
                }

                rescanBtn.disabled = true;
                rescanSpinner.classList.remove('hidden');
                rescanBtnText.classList.add('hidden');

                try {
                    // First, clear all existing articles from the database
                    console.log('Clearing existing articles...');
                    const clearResponse = await fetch('/api/rescan-articles', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    if (!clearResponse.ok) {
                        const errorData = await clearResponse.json();
                        throw new Error(errorData.error || 'Failed to clear articles');
                    }

                    console.log('Articles cleared, starting fresh scan...');
                    
                    // Clear local posts array
                    allPosts = [];
                    renderPosts(allPosts);

                    // Now scan all repositories fresh with cache busting
                    let newAllPosts = [];
                    for (const repo of repositories) {
                        console.log(`Rescanning repository: ${repo} (with cache busting)`);
                        const posts = await getArticlesFromRepo(repo, true); // Force cache busting for rescan
                        newAllPosts = newAllPosts.concat(posts);
                    }
                    allPosts = newAllPosts;
                    
                    console.log(`Found ${allPosts.length} articles total`);
                    
                    // Save all articles to server database
                    if (allPosts.length > 0) {
                        const saveResponse = await fetch('/api/save-articles', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(allPosts)
                        });
                        if (saveResponse.ok) {
                            console.log('All articles saved to database successfully');
                        } else {
                            console.error('Failed to save articles to database');
                        }
                    }
                    
                    // Generate images for all articles
                    for (let post of allPosts) {
                        const response = await fetch('/api/generate-image', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ title: post.title })
                        });

                        if (response.ok) {
                            const data = await response.json();
                            post.imageUrl = data.image_url;
                        }
                    }

                    // Final save with images
                    if (allPosts.length > 0) {
                        await fetch('/api/save-articles', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(allPosts)
                        });
                    }

                    renderPosts(allPosts);
                    alert(`Rescan completed! Found and processed ${allPosts.length} articles.`);

                } catch (error) {
                    console.error('Rescan failed:', error);
                    alert(`Rescan failed: ${error.message}`);
                } finally {
                    rescanBtn.disabled = false;
                    rescanSpinner.classList.add('hidden');
                    rescanBtnText.classList.remove('hidden');
                }
            }

            async function regenerateAllImages() {
                console.log('=== REGENERATE ALL IMAGES CALLED ===');
                console.log('All posts:', allPosts);
                
                if (allPosts.length === 0) {
                    console.log('No posts found');
                    alert('No articles found. Please scan for articles first.');
                    return;
                }

                if (!confirm(`This will regenerate images for all ${allPosts.length} articles. This may take some time. Continue?`)) {
                    console.log('User cancelled regeneration');
                    return;
                }

                console.log('Starting regeneration process...');
                regenerateImagesBtn.disabled = true;
                regenerateSpinner.classList.remove('hidden');
                regenerateBtnText.classList.add('hidden');

                regenerateProgress.classList.remove('hidden');
                let regeneratedCount = 0;
                const totalPosts = allPosts.length;
                
                for (let post of allPosts) {
                    console.log(`Processing post: ${post.title}`);
                    try {
                        console.log('Sending request to /api/generate-image...');
                        const response = await fetch('/api/generate-image', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ title: post.title })
                        });

                        console.log('Response status:', response.status);
                        if (response.ok) {
                            const data = await response.json();
                            console.log('Response data:', data);
                            post.imageUrl = data.image_url;
                            regeneratedCount++;

                            // Update Progress
                            progressText.textContent = `Regenerating images...`;
                            progressCount.textContent = `${regeneratedCount}/${totalPosts}`;
                            progressBar.style.width = `${(regeneratedCount / totalPosts) * 100}%`;
                        } else {
                            console.error('API request failed:', response.status, response.statusText);
                            const errorData = await response.json().catch(() => null);
                            console.error('Error data:', errorData);
                        }
                    } catch (error) {
                        console.error(`Failed to regenerate image for \"${post.title}\":`, error);
                    }
                }

                // Save updated articles to server database
                try {
                    const saveResponse = await fetch('/api/save-articles', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(allPosts)
                    });
                    if (saveResponse.ok) {
                        console.log('Updated articles saved to database');
                    }
                } catch (error) {
                    console.error('Failed to save updated articles:', error);
                }
                
                // Re-render posts to show new images
                renderPosts(allPosts);
                regenerateProgress.classList.add('hidden');

                regenerateImagesBtn.disabled = false;
                regenerateSpinner.classList.add('hidden');
                regenerateBtnText.classList.remove('hidden');

                alert(`Successfully regenerated ${regeneratedCount} images!`);
            }

            // --- Modal and Panel Toggles ---
            function openArticleModal(post) {
                modalTitle.textContent = post.title;
                modalContent.innerHTML = post.content;
                articleModal.classList.remove('hidden');
                articleModal.classList.add('flex');
                
                // Store current post for sharing
                window.currentPost = post;
                
                // Update URL hash to enable direct linking to articles
                window.history.pushState(null, null, `#article-${encodeURIComponent(post.path)}`);
                
                // Track article visit
                fetch('/api/track', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ article: post.title })
                }).catch(error => console.error('Failed to track visit:', error));
            }

            function closeArticleModal() {
                articleModal.classList.add('hidden');
                articleModal.classList.remove('flex');
                
                // Clear current post
                window.currentPost = null;
                
                // Clear URL hash when closing modal
                window.history.pushState(null, null, window.location.pathname);
            }

            function showAdminPanel() { 
                adminPanel.classList.remove('hidden'); 
            }
            function hideAdminPanel() { 
                adminPanel.classList.add('hidden'); 
            }
            function showAdminLogin() { adminLoginModal.classList.remove('hidden'); adminLoginModal.classList.add('flex'); }
            function hideAdminLogin() { adminLoginModal.classList.add('hidden'); adminLoginModal.classList.remove('flex'); }
            function showForcePasswordChange() { forcePasswordChangeModal.classList.remove('hidden'); forcePasswordChangeModal.classList.add('flex'); }
            function hideForcePasswordChange() { forcePasswordChangeModal.classList.add('hidden'); forcePasswordChangeModal.classList.remove('flex'); }

            // --- Admin Logic Handlers ---
            async function login(e) {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                try {
                    const response = await fetch('/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        isLoggedIn = true;
                        hideAdminLogin();

                        if (data.requires_password_change) {
                            showForcePasswordChange();
                        } else {
                            showAdminPanel();
                        }
                    } else {
                        alert('Invalid credentials');
                    }
                } catch (error) {
                    alert('Login failed. Please try again later.');
                }
            }

            async function handleForcePasswordChange(e) {
                e.preventDefault();
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;

                if (newPassword.length < 6) {
                    alert('Password must be at least 6 characters long.');
                    return;
                }
                if (newPassword !== confirmPassword) {
                    alert('Passwords do not match.');
                    return;
                }

                try {
                    const response = await fetch('/api/config/password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            current_password: 'password', // Default password for force change
                            new_password: newPassword 
                        })
                    });

                    if (response.ok) {
                        alert('Password changed successfully.');
                        hideForcePasswordChange();
                        showAdminPanel();
                    } else {
                        const data = await response.json();
                        alert(data.error || 'Failed to change password');
                    }
                } catch (error) {
                    alert('Failed to change password. Please try again.');
                }
            }

            async function handleChangePassword(e) {
                e.preventDefault();
                const currentPassword = document.getElementById('current-password-admin').value;
                const newPassword = document.getElementById('new-password-admin').value;
                const confirmPassword = document.getElementById('confirm-password-admin').value;

                if (newPassword.length < 6) {
                    alert('New password must be at least 6 characters long.');
                    return;
                }
                if (newPassword !== confirmPassword) {
                    alert('New passwords do not match.');
                    return;
                }

                try {
                    const response = await fetch('/api/config/password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            current_password: currentPassword,
                            new_password: newPassword 
                        })
                    });

                    if (response.ok) {
                        alert('Password updated successfully.');
                        e.target.reset();
                    } else {
                        const data = await response.json();
                        alert(data.error || 'Failed to update password');
                    }
                } catch (error) {
                    alert('Failed to update password. Please try again.');
                }
            }

            async function addRepo(e) {
                e.preventDefault();
                const repoUrl = repoUrlInput.value.trim();
                
                if (!repoUrl) return;
                
                try {
                    const response = await fetch('/api/repositories', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ repository: repoUrl })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        repositories = data.repositories;
                        renderRepos();
                        repoUrlInput.value = '';
                    } else {
                        const data = await response.json();
                        alert(data.error || 'Failed to add repository');
                    }
                } catch (error) {
                    alert('Failed to add repository. Please try again.');
                }
            }

            async function removeRepo(e) {
                if (e.target.classList.contains('remove-repo-btn')) {
                    const index = parseInt(e.target.dataset.index);
                    
                    try {
                        const response = await fetch(`/api/repositories/${index}`, {
                            method: 'DELETE'
                        });

                        if (response.ok) {
                            const data = await response.json();
                            repositories = data.repositories;
                            renderRepos();
                        } else {
                            const data = await response.json();
                            alert(data.error || 'Failed to remove repository');
                        }
                    } catch (error) {
                        alert('Failed to remove repository. Please try again.');
                    }
                }
            }

            async function handleBlogNameUpdate(e) {
                e.preventDefault();
                const newName = blogNameInput.value.trim();
                
                if (!newName) return;
                
                try {
                    const response = await fetch('/api/config/blog-name', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ blog_name: newName })
                    });

                    if (response.ok) {
                        blogConfig.blog_name = newName;
                        updateBlogName();
                        alert('Blog name updated!');
                    } else {
                        const data = await response.json();
                        alert(data.error || 'Failed to update blog name');
                    }
                } catch (error) {
                    alert('Failed to update blog name. Please try again.');
                }
            }

            async function handleGeminiApiKeySubmit(e) {
                e.preventDefault();
                const apiKey = geminiApiKeyInput.value.trim();
                
                if (!apiKey) {
                    alert('Please enter an API key');
                    return;
                }
                
                try {
                    const response = await fetch('/api/config/gemini-api-key', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ api_key: apiKey })
                    });

                    if (response.ok) {
                        blogConfig.has_gemini_api_key = true;
                        updateGeminiStatus();
                        alert('Gemini API key saved successfully!');
                        geminiApiKeyInput.value = '';
                    } else {
                        const data = await response.json();
                        alert(data.error || 'Failed to save API key');
                    }
                } catch (error) {
                    alert('Failed to save API key. Please try again.');
                }
            }

            async function handleOpenaiApiKeySubmit(e) {
                e.preventDefault();
                const apiKey = openaiApiKeyInput.value.trim();
                
                if (!apiKey) {
                    alert('Please enter an API key');
                    return;
                }
                
                try {
                    const response = await fetch('/api/config/openai-api-key', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ api_key: apiKey })
                    });

                    if (response.ok) {
                        blogConfig.has_openai_api_key = true;
                        updateOpenaiStatus();
                        alert('OpenAI API key saved successfully!');
                        openaiApiKeyInput.value = '';
                    } else {
                        const data = await response.json();
                        alert(data.error || 'Failed to save API key');
                    }
                } catch (error) {
                    alert('Failed to save API key. Please try again.');
                }
            }

            function toggleOpenaiPasswordVisibility() {
                const eyeOpen = document.getElementById('openai-eye-open');
                const eyeClosed = document.getElementById('openai-eye-closed');
                
                if (openaiApiKeyInput.type === 'password') {
                    openaiApiKeyInput.type = 'text';
                    eyeOpen.classList.add('hidden');
                    eyeClosed.classList.remove('hidden');
                } else {
                    openaiApiKeyInput.type = 'password';
                    eyeOpen.classList.remove('hidden');
                    eyeClosed.classList.add('hidden');
                }
            }

            function toggleGeminiPasswordVisibility() {
                const eyeOpen = document.getElementById('eye-open');
                const eyeClosed = document.getElementById('eye-closed');
                
                if (geminiApiKeyInput.type === 'password') {
                    geminiApiKeyInput.type = 'text';
                    eyeOpen.classList.add('hidden');
                    eyeClosed.classList.remove('hidden');
                } else {
                    geminiApiKeyInput.type = 'password';
                    eyeOpen.classList.remove('hidden');
                    eyeClosed.classList.add('hidden');
                }
            }

            // --- ANALYTICS FUNCTIONS ---
            async function loadAnalytics() {
                loadAnalyticsBtn.disabled = true;
                loadAnalyticsBtn.textContent = 'Loading...';
                
                try {
                    const response = await fetch('/api/analytics/stats');
                    if (response.ok) {
                        const data = await response.json();
                        renderAnalytics(data);
                        analyticsData.classList.remove('hidden');
                        loadAnalyticsBtn.textContent = 'Refresh Analytics';
                    } else {
                        const errorData = await response.json();
                        alert(errorData.error || 'Failed to load analytics');
                        loadAnalyticsBtn.textContent = 'Load Analytics Data';
                    }
                } catch (error) {
                    console.error('Error loading analytics:', error);
                    alert('Failed to load analytics. Please try again.');
                    loadAnalyticsBtn.textContent = 'Load Analytics Data';
                } finally {
                    loadAnalyticsBtn.disabled = false;
                }
            }

            function renderAnalytics(data) {
                // Update summary cards
                totalHitsEl.textContent = data.total_hits || 0;
                uniqueVisitorsEl.textContent = data.unique_visitors || 0;
                topArticleViewsEl.textContent = data.top_articles?.[0]?.views || 0;
                countriesCountEl.textContent = data.top_countries?.length || 0;
                
                // Render top articles
                topArticlesList.innerHTML = '';
                if (data.top_articles && data.top_articles.length > 0) {
                    data.top_articles.forEach(article => {
                        const articleEl = document.createElement('div');
                        articleEl.className = 'flex justify-between items-center p-2 bg-white rounded border';
                        articleEl.innerHTML = `
                            <div class="flex-1">
                                <div class="font-medium text-sm truncate" title="${article.article}">${article.article}</div>
                                <div class="text-xs text-gray-500">${article.countries.join(', ')}</div>
                            </div>
                            <div class="text-sm font-semibold text-blue-600">${article.views}</div>
                        `;
                        topArticlesList.appendChild(articleEl);
                    });
                } else {
                    topArticlesList.innerHTML = '<div class="text-gray-500 text-sm">No article data available</div>';
                }
                
                // Render top countries
                topCountriesList.innerHTML = '';
                if (data.top_countries && data.top_countries.length > 0) {
                    data.top_countries.forEach(country => {
                        const countryEl = document.createElement('div');
                        countryEl.className = 'flex justify-between items-center p-2 bg-white rounded border';
                        countryEl.innerHTML = `
                            <div class="font-medium text-sm">${country.country}</div>
                            <div class="text-sm font-semibold text-green-600">${country.visits}</div>
                        `;
                        topCountriesList.appendChild(countryEl);
                    });
                } else {
                    topCountriesList.innerHTML = '<div class="text-gray-500 text-sm">No country data available</div>';
                }
                
                // Render daily stats chart (simple bar chart)
                dailyStatsChart.innerHTML = '';
                if (data.daily_stats && data.daily_stats.length > 0) {
                    const maxVisits = Math.max(...data.daily_stats.map(d => d.visits));
                    const chartContainer = document.createElement('div');
                    chartContainer.className = 'flex items-end space-x-1 h-full';
                    
                    data.daily_stats.reverse().forEach(day => {
                        const barHeight = maxVisits > 0 ? (day.visits / maxVisits) * 200 : 0;
                        const bar = document.createElement('div');
                        bar.className = 'bg-indigo-500 rounded-t flex-1 min-w-0 relative group cursor-pointer';
                        bar.style.height = `${barHeight}px`;
                        bar.innerHTML = `
                            <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2 py-1 bg-black text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">
                                ${day.date}: ${day.visits} visits
                            </div>
                        `;
                        chartContainer.appendChild(bar);
                    });
                    
                    dailyStatsChart.appendChild(chartContainer);
                } else {
                    dailyStatsChart.innerHTML = '<div class="text-gray-500 text-sm flex items-center justify-center h-full">No recent activity data available</div>';
                }
            }

            // --- Utility: Grapheme-safe length and trimming ---
            function countGraphemes(str) {
                try {
                    if (window.Intl && Intl.Segmenter) {
                        const seg = new Intl.Segmenter(undefined, { granularity: 'grapheme' });
                        return Array.from(seg.segment(str)).length;
                    }
                } catch {}
                return Array.from(str).length; // Fallback: code points
            }
            function trimToGraphemes(str, max) {
                try {
                    if (window.Intl && Intl.Segmenter) {
                        const seg = new Intl.Segmenter(undefined, { granularity: 'grapheme' });
                        const it = seg.segment(str)[Symbol.iterator]();
                        let out = '';
                        let count = 0;
                        while (count < max) {
                            const n = it.next();
                            if (n.done) break;
                            out += n.value.segment;
                            count++;
                        }
                        return out;
                    }
                } catch {}
                // Fallback: slice by code points
                return Array.from(str).slice(0, max).join('');
            }
            function composeBlueskyFields(title, plainContent, url, maxGraphemes = 300) {
                // We assume backend posts: title + "\n\n" + content + "\n\n" + url
                const sep = '\n\n';
                let t = title || '';
                let c = plainContent || '';
                const u = url || '';
                // Function to compute total length
                const totalLen = () => countGraphemes(t) + (t ? countGraphemes(sep) : 0)
                                   + (c ? countGraphemes(c) + countGraphemes(sep) : 0)
                                   + (u ? countGraphemes(u) : 0);
                // Trim content first
                let ellipsis = '…';
                while (totalLen() > maxGraphemes && c) {
                    const budget = Math.max(0, maxGraphemes - (countGraphemes(t) + (t ? countGraphemes(sep) : 0) + (u ? countGraphemes(sep) + countGraphemes(u) : 0)));
                    if (budget <= 0) { c = ''; break; }
                    // keep room for ellipsis if we are trimming
                    const trimmed = trimToGraphemes(c, Math.max(0, budget - countGraphemes(ellipsis)));
                    if (countGraphemes(trimmed) < countGraphemes(c)) {
                        c = trimmed + ellipsis;
                    } else {
                        break;
                    }
                }
                // If still too long, trim title
                while (totalLen() > maxGraphemes && t) {
                    const budget = Math.max(0, maxGraphemes - ((c ? countGraphemes(c) + countGraphemes(sep) : 0) + (u ? countGraphemes(u) : 0)));
                    if (budget <= 0) { t = ''; break; }
                    const trimmedT = trimToGraphemes(t, Math.max(0, budget - countGraphemes(ellipsis)));
                    if (countGraphemes(trimmedT) < countGraphemes(t)) {
                        t = trimmedT + ellipsis;
                    } else {
                        break;
                    }
                }
                return { title: t, content: c, url: u };
            }

            // --- BLUESKY FUNCTIONS ---
            function updateBlueskyStatus() {
                if (blogConfig.has_bluesky_credentials) {
                    blueskyStatusElement.textContent = 'Configured';
                    blueskyStatusElement.className = 'px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800';
                    blueskyHandleDisplay.textContent = blogConfig.bluesky_handle;
                    testBlueskyConnectionBtn.disabled = false;
                    blueskyActions.classList.remove('hidden');
                    
                    // Pre-populate form with current handle
                    if (blueskyHandleInput && blogConfig.bluesky_handle) {
                        blueskyHandleInput.value = blogConfig.bluesky_handle;
                    }
                } else {
                    blueskyStatusElement.textContent = 'Not Configured';
                    blueskyStatusElement.className = 'px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800';
                    blueskyHandleDisplay.textContent = 'Not configured';
                    testBlueskyConnectionBtn.disabled = true;
                    blueskyActions.classList.add('hidden');
                }
            }

            async function handleBlueskyConfigSubmit(e) {
                e.preventDefault();
                const handle = blueskyHandleInput.value.trim();
                const appPassword = blueskyAppPasswordInput.value.trim();
                
                if (!handle || !appPassword) {
                    alert('Please enter both handle and app password');
                    return;
                }
                
                try {
                    const response = await fetch('/api/config/bluesky', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ handle, app_password: appPassword })
                    });

                    if (response.ok) {
                        blogConfig.has_bluesky_credentials = true;
                        blogConfig.bluesky_handle = handle;
                        updateBlueskyStatus();
                        alert('Bluesky configuration saved successfully!');
                        blueskyAppPasswordInput.value = ''; // Clear password field
                    } else {
                        const data = await response.json();
                        alert(data.error || 'Failed to save Bluesky configuration');
                    }
                } catch (error) {
                    alert('Failed to save Bluesky configuration. Please try again.');
                }
            }

            async function testBlueskyConnection() {
                testBlueskyConnectionBtn.disabled = true;
                const originalText = testBlueskyConnectionBtn.textContent;
                testBlueskyConnectionBtn.textContent = 'Testing...';
                
                try {
                    const response = await fetch('/api/bluesky/test-connection', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        alert(data.message || 'Bluesky connection successful!');
                    } else {
                        const data = await response.json();
                        alert(data.error || 'Failed to connect to Bluesky');
                    }
                } catch (error) {
                    alert('Failed to test Bluesky connection. Please try again.');
                } finally {
                    testBlueskyConnectionBtn.disabled = false;
                    testBlueskyConnectionBtn.textContent = originalText;
                }
            }

            async function postLatestArticleToBluesky() {
                if (allPosts.length === 0) {
                    alert('No articles found. Please scan for articles first.');
                    return;
                }

                const latestPost = allPosts[0]; // Assuming posts are sorted by date
                
                postLatestArticleBtn.disabled = true;
                document.getElementById('post-latest-text').classList.add('hidden');
                document.getElementById('post-latest-spinner').classList.remove('hidden');
                
                try {
                    const articleUrl = `${window.location.origin}${window.location.pathname}#article-${encodeURIComponent(latestPost.path)}`;
                    const plain = latestPost.content.replace(/\u003c[^\u003e]*\u003e/g, '');
                    // Compose fields to fit within 300 graphemes
                    const composed = composeBlueskyFields(latestPost.title, plain, articleUrl, 300);
                    
                    const response = await fetch('/api/bluesky/post-article', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            title: composed.title,
                            content: composed.content,
                            url: composed.url,
                            image_url: latestPost.imageUrl
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        alert(`Successfully posted "${latestPost.title}" to Bluesky!\n\nPost URI: ${data.post_uri}`);
                    } else {
                        const data = await response.json();
                        alert(data.error || 'Failed to post to Bluesky');
                    }
                } catch (error) {
                    alert('Failed to post to Bluesky. Please try again.');
                } finally {
                    postLatestArticleBtn.disabled = false;
                    document.getElementById('post-latest-text').classList.remove('hidden');
                    document.getElementById('post-latest-spinner').classList.add('hidden');
                }
            }

            async function bulkPostArticlesToBluesky() {
                if (allPosts.length === 0) {
                    alert('No articles found. Please scan for articles first.');
                    return;
                }

                const recentPosts = allPosts.slice(0, 5); // Post up to 5 most recent articles
                
                if (!confirm(`This will post the ${recentPosts.length} most recent articles to Bluesky. Continue?`)) {
                    return;
                }
                
                bulkPostArticlesBtn.disabled = true;
                document.getElementById('bulk-post-text').classList.add('hidden');
                document.getElementById('bulk-post-spinner').classList.remove('hidden');
                
                let successCount = 0;
                let failCount = 0;
                
                try {
                    for (const post of recentPosts) {
                        const articleUrl = `${window.location.origin}${window.location.pathname}#article-${encodeURIComponent(post.path)}`;
                        
                        try {
                            const plain = post.content.replace(/\u003c[^\u003e]*\u003e/g, '');
                            const composed = composeBlueskyFields(post.title, plain, articleUrl, 300);
                            const response = await fetch('/api/bluesky/post-article', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    title: composed.title,
                                    content: composed.content,
                                    url: composed.url,
                                    image_url: post.imageUrl
                                })
                            });

                            if (response.ok) {
                                successCount++;
                            } else {
                                failCount++;
                            }
                            
                            // Add a small delay between posts to be respectful to the API
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            
                        } catch (error) {
                            failCount++;
                        }
                    }
                    
                    alert(`Bulk posting completed!\n\nSuccessful: ${successCount}\nFailed: ${failCount}`);
                    
                } catch (error) {
                    alert('Bulk posting failed. Please try again.');
                } finally {
                    bulkPostArticlesBtn.disabled = false;
                    document.getElementById('bulk-post-text').classList.remove('hidden');
                    document.getElementById('bulk-post-spinner').classList.add('hidden');
                }
            }

            function toggleBlueskyPasswordVisibility() {
                const eyeOpen = document.getElementById('bluesky-eye-open');
                const eyeClosed = document.getElementById('bluesky-eye-closed');
                
                if (blueskyAppPasswordInput.type === 'password') {
                    blueskyAppPasswordInput.type = 'text';
                    eyeOpen.classList.add('hidden');
                    eyeClosed.classList.remove('hidden');
                } else {
                    blueskyAppPasswordInput.type = 'password';
                    eyeOpen.classList.remove('hidden');
                    eyeClosed.classList.add('hidden');
                }
            }

            // --- FEDIVERSE FUNCTIONS ---
            function updateFediverseStatus() {
                if (blogConfig.has_fediverse_credentials) {
                    fediverseStatusElement.textContent = 'Configured';
                    fediverseStatusElement.className = 'px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800';
                    fediverseInstanceDisplay.textContent = blogConfig.fediverse_instance || 'Not configured';
                    fediverseUsernameDisplay.textContent = blogConfig.fediverse_username || 'Not configured';
                    testFediverseConnectionBtn.disabled = false;
                    fediverseActions.classList.remove('hidden');
                    
                    // Pre-populate form with current values
                    if (fediverseInstanceInput && blogConfig.fediverse_instance) {
                        fediverseInstanceInput.value = blogConfig.fediverse_instance;
                    }
                    if (fediverseUsernameInput && blogConfig.fediverse_username) {
                        fediverseUsernameInput.value = blogConfig.fediverse_username;
                    }
                } else {
                    fediverseStatusElement.textContent = 'Not Configured';
                    fediverseStatusElement.className = 'px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800';
                    fediverseInstanceDisplay.textContent = 'Not configured';
                    fediverseUsernameDisplay.textContent = 'Not configured';
                    testFediverseConnectionBtn.disabled = true;
                    fediverseActions.classList.add('hidden');
                }
            }

            async function handleFediverseConfigSubmit(e) {
                e.preventDefault();
                const instance = fediverseInstanceInput.value.trim();
                const username = fediverseUsernameInput.value.trim();
                const accessToken = fediverseAccessTokenInput.value.trim();
                
                if (!instance || !username || !accessToken) {
                    alert('Please fill in all fields: instance URL, username, and access token');
                    return;
                }
                
                // Basic URL validation
                try {
                    new URL(instance);
                } catch {
                    alert('Please enter a valid instance URL (e.g., https://mastodon.social)');
                    return;
                }
                
                try {
                    const response = await fetch('/api/config/fediverse', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            instance: instance,
                            username: username,
                            access_token: accessToken 
                        })
                    });

                    if (response.ok) {
                        blogConfig.has_fediverse_credentials = true;
                        blogConfig.fediverse_instance = instance;
                        blogConfig.fediverse_username = username;
                        updateFediverseStatus();
                        alert('Fediverse configuration saved successfully!');
                        fediverseAccessTokenInput.value = ''; // Clear access token field
                    } else {
                        const data = await response.json();
                        alert(data.error || 'Failed to save Fediverse configuration');
                    }
                } catch (error) {
                    alert('Failed to save Fediverse configuration. Please try again.');
                }
            }

            async function testFediverseConnection() {
                testFediverseConnectionBtn.disabled = true;
                const originalText = testFediverseConnectionBtn.textContent;
                testFediverseConnectionBtn.textContent = 'Testing...';
                
                try {
                    const response = await fetch('/api/fediverse/test-connection', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        alert(data.message || 'Fediverse connection successful!');
                    } else {
                        const data = await response.json();
                        alert(data.error || 'Failed to connect to Fediverse');
                    }
                } catch (error) {
                    alert('Failed to test Fediverse connection. Please try again.');
                } finally {
                    testFediverseConnectionBtn.disabled = false;
                    testFediverseConnectionBtn.textContent = originalText;
                }
            }

            async function postLatestArticleToFediverse() {
                if (allPosts.length === 0) {
                    alert('No articles found. Please scan for articles first.');
                    return;
                }

                const latestPost = allPosts[0]; // Assuming posts are sorted by date
                
                postLatestArticleFediverseBtn.disabled = true;
                document.getElementById('post-latest-fediverse-text').classList.add('hidden');
                document.getElementById('post-latest-fediverse-spinner').classList.remove('hidden');
                
                try {
                    const articleUrl = `${window.location.origin}${window.location.pathname}#article-${encodeURIComponent(latestPost.path)}`;
                    
                    // Create hashtags from the article tag
                    const hashtags = latestPost.tag ? `#${latestPost.tag.replace(/\s+/g, '').toLowerCase()}` : '#blog';
                    
                    const response = await fetch('/api/fediverse/post-article', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            title: latestPost.title,
                            content: latestPost.content.replace(/<[^>]*>/g, '').substring(0, 200), // Strip HTML and limit length
                            url: articleUrl,
                            hashtags: hashtags
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        alert(`Successfully posted "${latestPost.title}" to Fediverse!\n\nPost URL: ${data.post_url}`);
                    } else {
                        const data = await response.json();
                        alert(data.error || 'Failed to post to Fediverse');
                    }
                } catch (error) {
                    alert('Failed to post to Fediverse. Please try again.');
                } finally {
                    postLatestArticleFediverseBtn.disabled = false;
                    document.getElementById('post-latest-fediverse-text').classList.remove('hidden');
                    document.getElementById('post-latest-fediverse-spinner').classList.add('hidden');
                }
            }

            async function bulkPostArticlesToFediverse() {
                if (allPosts.length === 0) {
                    alert('No articles found. Please scan for articles first.');
                    return;
                }

                const recentPosts = allPosts.slice(0, 5); // Post up to 5 most recent articles
                
                if (!confirm(`This will post the ${recentPosts.length} most recent articles to Fediverse. Continue?`)) {
                    return;
                }
                
                bulkPostArticlesFediverseBtn.disabled = true;
                document.getElementById('bulk-post-fediverse-text').classList.add('hidden');
                document.getElementById('bulk-post-fediverse-spinner').classList.remove('hidden');
                
                let successCount = 0;
                let failCount = 0;
                
                try {
                    for (const post of recentPosts) {
                        const articleUrl = `${window.location.origin}${window.location.pathname}#article-${encodeURIComponent(post.path)}`;
                        const hashtags = post.tag ? `#${post.tag.replace(/\s+/g, '').toLowerCase()}` : '#blog';
                        
                        try {
                            const response = await fetch('/api/fediverse/post-article', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    title: post.title,
                                    content: post.content.replace(/<[^>]*>/g, '').substring(0, 200),
                                    url: articleUrl,
                                    hashtags: hashtags
                                })
                            });

                            if (response.ok) {
                                successCount++;
                            } else {
                                failCount++;
                            }
                            
                            // Add a delay between posts to be respectful to the instance
                            await new Promise(resolve => setTimeout(resolve, 2000)); // 2 seconds for Mastodon
                            
                        } catch (error) {
                            failCount++;
                        }
                    }
                    
                    alert(`Bulk posting completed!\n\nSuccessful: ${successCount}\nFailed: ${failCount}`);
                    
                } catch (error) {
                    alert('Bulk posting failed. Please try again.');
                } finally {
                    bulkPostArticlesFediverseBtn.disabled = false;
                    document.getElementById('bulk-post-fediverse-text').classList.remove('hidden');
                    document.getElementById('bulk-post-fediverse-spinner').classList.add('hidden');
                }
            }

            function toggleFediversePasswordVisibility() {
                const eyeOpen = document.getElementById('fediverse-eye-open');
                const eyeClosed = document.getElementById('fediverse-eye-closed');
                
                if (fediverseAccessTokenInput.type === 'password') {
                    fediverseAccessTokenInput.type = 'text';
                    eyeOpen.classList.add('hidden');
                    eyeClosed.classList.remove('hidden');
                } else {
                    fediverseAccessTokenInput.type = 'password';
                    eyeOpen.classList.remove('hidden');
                    eyeClosed.classList.add('hidden');
                }
            }

            // --- SIDEBAR NAVIGATION ---
            const ADMIN_SECTIONS = ['analytics','repositories','actions','blog-settings','security','ai-services','social-media'];

            function showAdminSection(sectionName) {
                // Hide all sections
                document.querySelectorAll('.admin-section').forEach(section => {
                    section.classList.add('hidden');
                });
                
                // Remove active state from all nav items
                document.querySelectorAll('.sidebar-nav-item').forEach(item => {
                    item.classList.remove('bg-indigo-100', 'text-indigo-700');
                });
                
                // Show the selected section
                const targetSection = document.getElementById(`section-${sectionName}`);
                if (targetSection) {
                    targetSection.classList.remove('hidden');
                }
                
                // Add active state to clicked nav item
                const activeNavItem = document.querySelector(`[data-section="${sectionName}"]`);
                if (activeNavItem) {
                    activeNavItem.classList.add('bg-indigo-100', 'text-indigo-700');
                }
            }

            function navigateToAdminSection(sectionName) {
                // Normalize section name and ensure it's valid
                const target = ADMIN_SECTIONS.includes(sectionName) ? sectionName : 'analytics';
                // Set hash-based route, triggering hashchange
                const newHash = `#settings/${target}`;
                if (window.location.hash !== newHash) {
                    window.location.hash = newHash;
                } else {
                    // If already on same hash, manually handle route
                    handleHashRoute();
                }
            }

            function handleHashRoute() {
                const hash = window.location.hash || '';
                // Admin routing: #settings or #settings/<section>
                if (hash.startsWith('#settings')) {
                    if (isLoggedIn) {
                        showAdminPanel();
                        const parts = hash.split('/');
                        const section = parts[1] ? parts[1] : 'analytics'; // when hash is exactly '#settings'
                        const normalized = ADMIN_SECTIONS.includes(section) ? section : 'analytics';
                        showAdminSection(normalized);
                    } else {
                        // Not logged in: show login modal and remember desired section
                        showAdminLogin();
                    }
                }
                // Article deep link handled elsewhere via checkForArticleHash
            }

            // --- INITIALIZATION ---
            async function init() {
                // Always load public config first (available to all visitors)
                await loadPublicConfig();
                
                // Check authentication status and load full config if authenticated
                await checkAuthStatus();
                if (isLoggedIn) {
                    await loadConfig();
                }

// Load articles from the server database
async function loadArticles() {
    try {
        const response = await fetch('/api/articles');
        if (response.ok) {
            const data = await response.json();
            allPosts = data;
            renderPosts(allPosts);
        } else {
            console.error('Failed to load articles:', response.status, response.statusText);
        }
    } catch (error) {
        console.error('Error loading articles:', error);
    }
}

                updateBlogName();
                renderRepos();

                // Load articles on initial page load
                loadArticles();
                
                // Check if URL has article hash and open that article
                checkForArticleHash();

 // Event Listeners
searchInput.addEventListener('input', handleSearch);
                blogPostsContainer.addEventListener('click', (e) => {
                    handleLike(e);
                    handleShare(e);
                });

                // Modal listeners
                modalCloseBtn.addEventListener('click', closeArticleModal);
                document.getElementById('modal-share').addEventListener('click', () => {
                    if (window.currentPost) {
                        const articleUrl = `${window.location.origin}${window.location.pathname}#article-${encodeURIComponent(window.currentPost.path)}`;
                        
                        if (navigator.share) {
                            navigator.share({
                                title: window.currentPost.title,
                                text: `Check out this article: ${window.currentPost.title}`,
                                url: articleUrl
                            }).catch(error => console.error('Error sharing:', error));
                        } else {
                            navigator.clipboard.writeText(articleUrl).then(() => {
                                alert('Article link copied to clipboard!');
                            }).catch(() => {
                                // Fallback for browsers that don't support clipboard API
                                const textArea = document.createElement('textarea');
                                textArea.value = articleUrl;
                                document.body.appendChild(textArea);
                                textArea.select();
                                document.execCommand('copy');
                                document.body.removeChild(textArea);
                                alert('Article link copied to clipboard!');
                            });
                        }
                    }
                });
                articleModal.addEventListener('click', (e) => {
                    if (e.target === articleModal) closeArticleModal();
                });

                // Admin listeners
                adminLoginBtn.addEventListener('click', () => {
                    if (isLoggedIn) {
                        // Navigate to default admin section as a page
                        navigateToAdminSection('analytics');
                    } else {
                        // Set the hash so that after login we can land in admin
                        window.location.hash = '#settings/analytics';
                        showAdminLogin();
                    }
                });
                adminLoginForm.addEventListener('submit', login);
                adminLoginCloseBtn.addEventListener('click', hideAdminLogin);
                adminPanelCloseBtn.addEventListener('click', () => {
                    hideAdminPanel();
                    // Clear settings hash if present
                    if (window.location.hash.startsWith('#settings')) {
                        history.pushState(null, '', window.location.pathname);
                    }
                });
                forcePasswordChangeForm.addEventListener('submit', handleForcePasswordChange);
                changePasswordForm.addEventListener('submit', handleChangePassword);
                addRepoForm.addEventListener('submit', addRepo);
                repoListContainer.addEventListener('click', removeRepo);
                scanBtn.addEventListener('click', scanForArticles);
                rescanBtn.addEventListener('click', rescanRepositories);
                regenerateImagesBtn.addEventListener('click', regenerateAllImages);
                blogNameForm.addEventListener('submit', handleBlogNameUpdate);
                // OpenAI API listeners
                openaiApiForm.addEventListener('submit', handleOpenaiApiKeySubmit);
                toggleOpenaiPasswordBtn.addEventListener('click', toggleOpenaiPasswordVisibility);
                // Gemini API listeners
                geminiApiForm.addEventListener('submit', handleGeminiApiKeySubmit);
                toggleGeminiPasswordBtn.addEventListener('click', toggleGeminiPasswordVisibility);
                // Analytics listener
                loadAnalyticsBtn.addEventListener('click', loadAnalytics);
                
                // Bluesky listeners
                blueskyConfigForm.addEventListener('submit', handleBlueskyConfigSubmit);
                testBlueskyConnectionBtn.addEventListener('click', testBlueskyConnection);
                toggleBlueskyPasswordBtn.addEventListener('click', toggleBlueskyPasswordVisibility);
                postLatestArticleBtn.addEventListener('click', postLatestArticleToBluesky);
                bulkPostArticlesBtn.addEventListener('click', bulkPostArticlesToBluesky);
                
                // Fediverse listeners
                fediverseConfigForm.addEventListener('submit', handleFediverseConfigSubmit);
                testFediverseConnectionBtn.addEventListener('click', testFediverseConnection);
                toggleFediversePasswordBtn.addEventListener('click', toggleFediversePasswordVisibility);
                postLatestArticleFediverseBtn.addEventListener('click', postLatestArticleToFediverse);
                bulkPostArticlesFediverseBtn.addEventListener('click', bulkPostArticlesToFediverse);
                
                // Sidebar navigation listeners
                document.querySelectorAll('.sidebar-nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const section = e.currentTarget.dataset.section;
                        navigateToAdminSection(section);
                    });
                });
                
                // Set default active section when opening admin panel
                if (isLoggedIn) {
                    // If a settings hash is already present, route to it; otherwise default
                    if (window.location.hash.startsWith('#settings')) {
                        handleHashRoute();
                    } else {
                        showAdminSection('analytics');
                    }
                }
            }

            // Function to check URL hash and open specific article
            function checkForArticleHash() {
                const hash = window.location.hash;
                if (hash.startsWith('#article-')) {
                    const articlePath = decodeURIComponent(hash.substring(9)); // Remove '#article-'
                    // Wait a bit for articles to load, then try to open the article
                    setTimeout(() => {
                        const article = allPosts.find(post => post.path === articlePath);
                        if (article) {
                            openArticleModal(article);
                        }
                    }, 500);
                }
            }
            
            // Listen for hash changes (back/forward browser navigation)
            window.addEventListener('hashchange', () => {
                const hash = window.location.hash;
                if (!hash) {
                    // Hash was cleared
                    if (!articleModal.classList.contains('hidden')) {
                        closeArticleModal();
                    }
                    if (!adminPanel.classList.contains('hidden')) {
                        hideAdminPanel();
                    }
                    return;
                }

                // Route based on hash
                if (hash.startsWith('#article-')) {
                    checkForArticleHash();
                } else if (hash.startsWith('#settings')) {
                    handleHashRoute();
                }
            });

            init();
            // Handle initial hash route for settings as page navigation
            handleHashRoute();
        });
    </script>
</body>
</html>
